<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Affects on the R package of the Patentsview api changes announced in
2021 • patentsview</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script>



  <link href="extra.css" rel="stylesheet">
  

<meta property="og:title" content="Affects on the R package of the Patentsview api changes announced in
2021" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-title-body">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">patentsview</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="articles/getting-started.html">
    <span class="fas fa-play"></span>
     
    Getting started
  </a>
</li>
<li>
  <a href="articles/writing-queries.html">
    <span class="fas fa-pencil"></span>
     
    Writing queries
  </a>
</li>
<li>
  <a href="articles/examples.html">
    <span class="fas fa-code"></span>
     
    Examples
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-bar-chart"></span>
     
    Applications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="articles/top-assignees.html">
        <span class="fas fa-university"></span>
         
        Top assignees
      </a>
    </li>
    <li>
      <a href="articles/citation-networks.html">
        <span class="fas fa-long-arrow-left"></span>
         
        Citation networks
      </a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="reference/index.html">
    <span class="fas fa-info-circle"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="https://github.com/ropensci/patentsview">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>Affects on the R package of the Patentsview api changes announced in
2021</h1>
    </div>

<div id="affects-on-the-r-package-of-the-patentsview-api-changes-announced-in-2021" class="section level1">

<p>As announced <a href="https://patentsview.org/data-in-action/whats-new-patentsview-july-2021">here</a>
in 2021, the patentsview api will be changing sometime in 2022. This
will impact the r package in the following ways.</p>
<ol>
<li><p>An api key will be required and will affect all users. Following
the best practice of using an environmental variable to hold the value
(<a href="https://cran.r-project.org/web/packages/httr/vignettes/api-packages.html" class="uri">https://cran.r-project.org/web/packages/httr/vignettes/api-packages.html</a>),
PATENTSVIEW_API_KEY must exist in the environment. Changes in
search-pv.R</p></li>
<li>
<p>Endpoint Changes</p>
<ol>
<li>Two totally new endpoints
<ul>
<li>/api/v1/patent_citation/</li>
<li>/api/v1/application_citation/</li>
</ul>
</li>
<li>Original endpoints cpc, nbr and cpc become these endpoints:
<ul>
<li>/cpc_group</li>
<li>/cpc_subgroup</li>
<li>/cpc_subsection</li>
<li>/nber_category</li>
<li>/nber_subcategory</li>
<li>/uspc_mainclass</li>
<li>/uspc_subclass<br>
Note that cpc_subsection looks like the existing cpc endpoint and
uspc_mainclass looks like the existing uspc endpoint but they behave
quite differently.</li>
</ul>
</li>
<li>Existing endpoints currently on the test server
<ul>
<li>/patent</li>
<li>/assignee</li>
<li>/inventor</li>
</ul>
</li>
<li>Existing endpoints not currently on the test server
<ul>
<li>/location</li>
</ul>
</li>
</ol>
<p>The R package will continue to use the plural endpoints as it matches
the name of the returned data structure. Going singular caused casting
problems. Note that there are new, get-only convience endpoints that
take a url parameter. The r package can ignore these and just use the
ones that do posts and gets using q,f,s and o parameters.</p>
</li>
<li><p>Throttling will be imposed. An http status of 429 “Too many
requests” will be returned if more than 45 requests are received per
minute. The Retry-After header will specify the number of seconds to
wait before sending the next request. Changes in search-pv.R sleep
Retry-After seconds then retries the query to hide this change from
package users.</p></li>
<li><p>The subdomain domain and pattern of the endpoints are changing.
Corresponding changes made in search-pv.R existing   <a href="https://api.patentsview.org/cpc_subsections/query?q=" class="uri">https://api.patentsview.org/cpc_subsections/query?q=</a> new
  <a href="https://search.patentsview.org/api/v1/cpc_subsection/?q=" class="uri">https://search.patentsview.org/api/v1/cpc_subsection/?q=</a></p></li>
<li>
<p>Options change (o parameter)</p>
<ol>
<li>
<p>size and offset rather than page and per_page can be hidden from
users in search_pv.R</p>
<pre><code>offset = (page-1) * per_page,
size = per_page</code></pre>
</li>
<li><p>size/per_page maximum changes from 10,000 to 1,000 could affect
users maximum check and message changed in validate-args.R could throw a
warning when per_page is set above 1,000 send to api as 1,000</p></li>
<li><p>matched_subentities_only and include_subentity_total_counts seem
to have gone away. <a href="https://patentsview.org/api-v01-information-page" class="uri">https://patentsview.org/api-v01-information-page</a>
mentions Owing to de-normalized and split API design, sub-entity
information is not available directly via each endpoint. As a
consequence, “matched_subentity” option parameters are not
valid.</p></li>
<li><p>The api’s default result set size changed from 25 to 100 when no
side/per_page is specified. In search-pv.R it’s defaulted to 25 when not
specified, so no impact to current package users.</p></li>
</ol>
</li>
<li><p>POST requests will need to send JSON data (instead of string
representation of JSON). Added a Content-Type: application/json header
in search-pv.R, otherwise the api returned Unsupported Media Type (HTTP
415).</p></li>
<li>
<p>The data comes back in a different order than before. Not
positive that this is correct. ~~~~ in process-resp.R it’s
list(prsd_resp[[4]]), names = names(prsd_resp[4]), ~~~~ it used to be
~~~~ list(prsd_resp[[1]]), names = names(prsd_resp[1]), ~~~~ now the
order is error, count, total_hits, data while it used to be data, count,
total_patent_count</p>
<p>change in search-pv.R req_pages</p>
</li>
</ol>
<div id="observations" class="section level2">
<h2 class="hasAnchor">
<a href="#observations" class="anchor"></a>Observations</h2>
<ol>
<li>The endpoints are singular now, instead of being plural. Ex /patents
is now /patent The returned data structures are still plural, ex.
patents. The R package will keep using the plural endpoints to match the
returned data structures.</li>
<li>organization (formerly assignee_organization) is now a full text
field, formerly it had been a string</li>
<li>The swagger definition (<a href="https://search.patentsview.org/static/openapi_v2.yml" class="uri">https://search.patentsview.org/static/openapi_v2.yml</a>)
does not contain government interest fields, ipc fields, wipo fields,
lawyer fields, foreign_priority fields, examiner fields, pct fields, raw
inventor fields, coinventor fields, patent_firstnamed fields or
patent_num_claims. Assuming these fields are all going away.</li>
<li>There seems to be a change in case sensitivity compared to the
original api. The original api would return results for
q:{“patent_type”:“Design”} while the ElasticSearch version does
not.</li>
<li>Nested fields can be specified in the f: parameter (ex [
“patent_number”,
“assignees_at_grant.organization”,“assignees_at_grant.assignee”]) but
the api throws a 500 error when they are used in the q: parameter (ex:
q:{“cpc_current.cpc_subgroup_title”: “Hand tools”}). It also seems to
matter on the endpoints that use url parameters.</li>
<li>It probably won’t not matter to the r package but the slash in the
url parameters of /api/v1/uspc_subclass/{uspc_subclass_id}/ and
/api/v1/cpc_subgroup/{cpc_subgroup_id}/ need to be changed to colons,
ex. 100:1 for 100/1 and A01B1:00 for A01B1/00 and respectively. This can
be seen in the return from the patent endpoint’s
cpc_current.cpc_subgroup, example “<a href="https://search.patentsview.org/api/v1/cpc_subgroup/G01S7:4865/" class="uri">https://search.patentsview.org/api/v1/cpc_subgroup/G01S7:4865/</a>”
It’s a HATEOAS style link that conatins a colon instead of a slash.</li>
<li>The api seems like it will become less useful. A lot of use cases
will break, like the ones lists on <a href="https://docs.ropensci.org/patentsview/articles/examples.html" class="uri">https://docs.ropensci.org/patentsview/articles/examples.html</a>
</li>
<li>There used to be endpoint specific _counts ex total_assignee_count.
Now all the endpoints return total_hits</li>
</ol>
</div>
<div id="notes" class="section level2">
<h2 class="hasAnchor">
<a href="#notes" class="anchor"></a>Notes</h2>
<ol>
<li><p>The online documentation is lagging. The two new endpoints are
documented on <a href="https://patentsview.org/data-in-action/whats-new-patentsview-july-2021" class="uri">https://patentsview.org/data-in-action/whats-new-patentsview-july-2021</a>
but they’re missing the Query column (see the next note). Pages for the
other endpoint haven’t been changed. I created fake pages for
data-raw/mbr_fieldsdf.R to consume. They’re listed on <a href="https://patentsview.historicip.com/api/" class="uri">https://patentsview.historicip.com/api/</a>. If I was better
at R I would have parsed out the swagger definition <a href="https://search.patentsview.org/static/openapi_v2.yml" class="uri">https://search.patentsview.org/static/openapi_v2.yml</a> We
would need to iterate over the paths (the endpoints). The paths with url
parameters wouldn’t matter to the r package, it would continue to use
the ones that take the q,f,s and o parameters. The 200 responses’
content could be parsed, though I’m not sure strings can be
differentiate from full text fields.</p></li>
<li><p>All fields are queryable. From <a href="https://patentsview.org/apis/purpose" class="uri">https://patentsview.org/apis/purpose</a> Field List Please
refer to the 200 “Response” section for each endpoint for full list of
fields available. All the available fields are “queryable.” It’s
referring to the 200 Responses shown on the swagger page <a href="https://search.patentsview.org/swagger-ui/" class="uri">https://search.patentsview.org/swagger-ui/</a></p></li>
<li><p>The Swagger definition (<a href="https://patentsview.historicip.com/swagger/openapi_v2.yml" class="uri">https://patentsview.historicip.com/swagger/openapi_v2.yml</a>)
can be imported into Postman to give you a nicely loaded collection for
the changed api. You’ll just need to set a global variable PVIEW_KEY and
set the authorization’s value to {{PVIEW_KEY}}.<br></p></li>
<li>
<p>The swagger definition shows a X-Status-Reason-Code in addition
to the existing X-Status-Reason. Not sure it matters to or would be
useful for the r package ~~~~</p>
<blockquote>
<p>print(httr::headers(resp)[[‘X-Status-Reason’]]) [1] “Invaild field:
shoe_size” print(httr::headers(resp)[[‘X-Status-Reason-Code’]]) [1]
“ERR_Q” ~~~~</p>
</blockquote>
</li>
</ol>
</div>
<div id="todos" class="section level2">
<h2 class="hasAnchor">
<a href="#todos" class="anchor"></a>TODOS</h2>
<ol>
<li><p>Vignettes and examples need updating, some may not be possible
due to the api change, like searching inventors by location. I had to
add dev = “png” to the knitr::opts_chunk$set in
citation-networks.Rmd.orig to get it to render locally.</p></li>
<li><p>Make sure that all the comments have been updated.</p></li>
<li><p>Paging isn’t quite right, repeats first request if all_pages =
TRUE</p></li>
<li><p>For throttling testing the Sys.sleep(3) in search-pv.R was
removed. A warning was added if the call gets throttled so testthat
could expect_warning. Wondering if the warning is a good idea! Possibly
add an optional parameter to search_pv? Then the warning could be
suppressed by default.</p></li>
<li><p>Check if we need to do anything about JSON on Posts (#6 at the
top of the page) Posts seem to work so I think we’re ok.</p></li>
<li><p>Test that what comes back from the api calls matches the
spreadsheet and/or their Swagger definition (should be ultimate source
of truth). There’s a link to the spreadsheet at the bottom of <a href="https://patentsview.org/apis/purpose" class="uri">https://patentsview.org/apis/purpose</a></p></li>
<li><p>Implement the warning mentioned above (second change to the
options parameter)</p></li>
<li><p>Check if the location specific error checking is still needed
(throw_if_loc_error() in process-error.R). The locations endpoint won’t
return as many fields as before.</p></li>
<li><p>probably should remove printing of the url to stderr in search-pv
but it’s been so darn useful durning development</p></li>
<li><p>Maybe instead of having fake documentation, something like
data-raw/mbr_fieldsdf.R should read the swagger definition to produce
data-raw/fieldsdf.csv. It might not be able to tell strings from full
text fields though.</p></li>
<li><p>mbr_fieldsdf.R probably needs to output group.field where the
group doesn’t match the endpoint’s name. Ex. for the patent endpoint,
the group of patents doesn’t need the group to be specified but the
other fields would need to be preceded by their group and a dot. Or
change the fields in the fake documentation (to add the group.field
where necessary)?</p></li>
<li>
<p>we probably don’t need this in process-error.R though the
location endpoint is not on the test server yet</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="st">"Your request resulted in a 500 error, likely because you have "</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">"requested too many fields in your request (the locations endpoint "</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">"currently has restrictions on the number of fields/groups you can "</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">"request). Try slimming down your field list and trying again."</span></span></code></pre></div>
</li>
<li><p>problems with cast-pv-data.R We need the dots when requesting
data, ex. assignees_at_grant.state at patent endpoint, but then we don’t
want the dots when casting. Probably need to remove the dots from the
fake web pages and rescrape. get_fields would need to add the groups and
dot when the fields are nested. It’s the one test that fails.</p></li>
<li><p>casting may only be necessary to convert dates, the new version
of the api seems to return integers and floats. Exception seems to be
assignees_at_grant.type, it’s a string that probably should be an
int</p></li>
<li><p>probably shouldn’t have api-change.Rmd.orig as a
vignette.</p></li>
</ol>
</div>
<div id="try-it-yourself" class="section level2">
<h2 class="hasAnchor">
<a href="#try-it-yourself" class="anchor"></a>Try it yourself</h2>
<p>Steps to try this out locally</p>
<ol>
<li>Request an api key from the patentsview team <a href="https://patentsview.org/apis/keyrequest" class="uri">https://patentsview.org/apis/keyrequest</a>
</li>
<li>Set the environmental variable PATENTSVIEW_API_KEY value to your
key.<br>
ex: set PATENTSVIEW_API_KEY=your_key_here</li>
<li>Install the patentsview package from mustberuss’ api-change-2021
branch devtools::install_github(“<a href="mailto:mustberuss/patentsview@api-change-2021" class="email">mustberuss/patentsview@api-change-2021</a>”)</li>
</ol>
<p>The environmental variable’s name is the same one I used in the api’s
python wrapper <a href="https://github.com/mustberuss/PatentsView-APIWrapper/tree/api-change-2022" class="uri">https://github.com/mustberuss/PatentsView-APIWrapper/tree/api-change-2022</a></p>
</div>
<div id="questions" class="section level2">
<h2 class="hasAnchor">
<a href="#questions" class="anchor"></a>Questions</h2>
<ol>
<li>Should we bump the version number to 1.0.0? The api key alone
quarantees that the package won’t be backward compatible.</li>
<li>Are there any other fields changing type? (like assignee
organization becoming a full text field, formerly it had been a
string)</li>
<li>Are there more fields (like the government interests) that went
away?</li>
<li>Do we need to set up an api key as a secret? It would be needed if
there are api calls in the workflows. I set one in my repo but I think
everything has a skip_on_ci(). It’s retrieved in R-CMD-check.yaml which
might need to be removed.</li>
<li>It looks like Dates are the only thing that cast-pv-data needs to
convert. The api seems to return integers etc., not always strings.
Exception is assignees_at_grant.type, it’s still a string when it should
be an int</li>
<li>Is NEWS.md generated? Add a link to the page explaining the api
changes?</li>
<li>How to handle the release? For a while both versions of the api are
supposed to be around. Have people install the updated R package from a
branch on ropensci/patentsview? When the original version of the api is
retired do a CRAN build?    </li>
</ol>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by Christopher Baker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


