<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Converting an Existing Script • patentsview</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Converting an Existing Script">
<meta property="og:description" content="patentsview">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patentsview</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-flag"></span>
     
    API Changes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/api-changes.html">
        <span class="fas fa-exclamation"></span>
         
        2022 API Changes
      </a>
    </li>
    <li>
      <a href="../articles/converting-an-existing-script.html">
        <span class="fas fa-sync"></span>
         
        Converting an Existing Script
      </a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/getting-started.html">
    <span class="fas fa-play"></span>
     
    Getting started
  </a>
</li>
<li>
  <a href="../articles/writing-queries.html">
    <span class="fas fa-pencil"></span>
     
    Writing queries
  </a>
</li>
<li>
  <a href="../articles/examples.html">
    <span class="fas fa-code"></span>
     
    Examples
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-bar-chart"></span>
     
    Applications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/top-assignees.html">
        <span class="fas fa-university"></span>
         
        Top assignees
      </a>
    </li>
    <li>
      <a href="../articles/citation-networks.html">
        <span class="fas fa-long-arrow-left"></span>
         
        Citation networks
      </a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fas fa-info-circle"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="https://github.com/ropensci/patentsview">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="converting-an-existing-script_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Converting an Existing Script</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/patentsview/blob/master/vignettes/converting-an-existing-script.Rmd"><code>vignettes/converting-an-existing-script.Rmd</code></a></small>
      <div class="hidden name"><code>converting-an-existing-script.Rmd</code></div>

    </div>

    
    
<div id="necessary-script-changes" class="section level2">
<h2 class="hasAnchor">
<a href="#necessary-script-changes" class="anchor"></a>Necessary Script Changes</h2>
<p>If you have a script that worked with the original R package and
original version of the API, chances are it will need some possibly
substantial changes before it will work with the new version of the R
package and API.</p>
</div>
<div id="the-one-required-change" class="section level2">
<h2 class="hasAnchor">
<a href="#the-one-required-change" class="anchor"></a>The One Required Change</h2>
<p>First off you’ll need to <a href="https://patentsview.org/apis/keyrequest">request an API key</a>
and then set the environmental variable PATENTSVIEW_API_KEY to the value
of your API key. Ex. set PATENTSVIEW_API_KEY=My_api_key Without a valid
API key, all your calls will be rejected by the API. There would be a
small chance that that is all that is needed to convert a simple script
to use the new R package and new version of the API.</p>
</div>
<div id="the-new-throttling-limit" class="section level2">
<h2 class="hasAnchor">
<a href="#the-new-throttling-limit" class="anchor"></a>The New Throttling Limit</h2>
<p>Another new thing is a throttling limit. The new version of the API
only allows an individual API key to make 45 calls per minute. The call
that exceeds that limit is rejected but does return the number of
seconds to wait before calls would be allowed again. Fortunately, the R
package handles this for you! Your script will be chugging along and if
the API should return a throttling response, the R package will sleep
for the required number of seconds before automatically resending your
query! The only thing you may notice, besides a warning message, it that
the script will pause when throttled before it picks right back up
again.</p>
<p>The new versions of the API’s endpoints are less Swiss Army
Knife-like than before, where you could get nearly any data field from
any endpoint. Now they have substantially lighter responses and they
generally focus on data pertinent to that endpoint. In other words, you
can only get uspc fields from the uspc endpoints. This may mean you’ll
have to make multiple calls to different endpoints to get the same data
the old version of API used to return in a single call.</p>
<p>Take a look at the top <a href="../top-assignees.html">assignees
application</a>. It has to blend together information from separate
calls that used to be returned by a single call. This may push your
dplyr knowlegde to the limit.</p>
</div>
<div id="changed-field-names-and-types" class="section level2">
<h2 class="hasAnchor">
<a href="#changed-field-names-and-types" class="anchor"></a>Changed Field Names and Types</h2>
<p>The fields selected in the original stript not be available from the
new version’s endpoints. Fields like the government interests are no
longer available (see <a href="https://patentsview.org/data-in-action/whats-new-patentsview-july-2021" class="uri">https://patentsview.org/data-in-action/whats-new-patentsview-july-2021</a>).
Also, some attributes have new names, like name_last in the nested
inventor object. Now in the fields parameter it would be specified as
“inventor.name_last” where formerly it was “inventor_last_name” when
using the patents endpoint.</p>
<p>Also note that some field’s types have changed, meaning you’ll need
to use different operators within your query. Ex. assignee.organization
is now a full text field, formerly it was a string.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mustberuss.github.io/patentsview/index.html">patentsview</a></span><span class="op">)</span>

<span class="co"># Before you could do a </span>
<span class="va">qry_funs</span><span class="op">$</span><span class="fu">contains</span><span class="op">(</span>assignee_organization<span class="op">=</span><span class="st">"Rice University"</span><span class="op">)</span>
<span class="co">#&gt; {"_contains":{"assignee_organization":"Rice University"}}</span>

<span class="co"># now you would have to do </span>
<span class="va">qry_funs</span><span class="op">$</span><span class="fu">text_phrase</span><span class="op">(</span>assignees_at_grant.organization<span class="op">=</span><span class="st">"Rice University"</span><span class="op">)</span>
<span class="co">#&gt; {"_text_phrase":{"assignees_at_grant.organization":"Rice University"}}</span></code></pre></div>
</div>
<div id="reduced-query-size" class="section level2">
<h2 class="hasAnchor">
<a href="#reduced-query-size" class="anchor"></a>Reduced Query Size</h2>
<p>Another thing you are likely to run into is a reduced overall query
size, the total number of rows you can get in a fully paged result set.
In the past with all_pages = TRUE, the R package could retrieve 10 pages
of 10,000 rows each for you for a total row count of 100,000. Now the r
package can only retrieve a maximum of 10,000 rows by requesting 10
pages of 1,000 rows each.</p>
<p>If you want the same data as before, you’ll have to make multiple
calls to get around the reduction in overall rows you can get at one
time. The easiest way to do this is to add a date range to your query
and make multiple calls and blend the individual call’s results
together. Gee that sounds hard or at least annoying, doesn’t it? Well,
to answer the question of who is looking out for you, it’s us, the R
package team!</p>
</div>
<div id="additions-to-the-r-package" class="section level2">
<h2 class="hasAnchor">
<a href="#additions-to-the-r-package" class="anchor"></a>Additions to the R Package</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First, there is a new in_range query function</span>

<span class="va">range</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">in_range</span><span class="op">(</span>patent_date<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1970-01-01"</span>,<span class="st">"1983-02-28"</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># which will generate this, so you don't have to do it by hand</span>
<span class="va">range</span>
<span class="co">#&gt; {"_and":[{"_gte":{"patent_date":"1970-01-01"}},{"_lte":{"patent_date":"1983-02-28"}}]}</span></code></pre></div>
<p>Second, here’s a new function that should probably be added to the R
package. Given a query that probably shouldn’t contain patent_date, it
will return a list of start dates and end dates where each date range
would return less than the new limit of 10,000 rows.</p>
<p>Do you remember the example of splitting up a call on the original
version of the getting-started page? It had this query</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_qfuns.html">with_qfuns</a></span><span class="op">(</span><span class="fu">text_any</span><span class="op">(</span>patent_abstract <span class="op">=</span> <span class="st">'tool animal'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>which returns well in excess of 140,000 rows. The original getting
started page showed how to break that up into two calls by _and’ing in a
patent date.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query_1a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_qfuns.html">with_qfuns</a></span><span class="op">(</span>
  <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">and</a></span><span class="op">(</span>
    <span class="fu">text_any</span><span class="op">(</span>patent_abstract <span class="op">=</span> <span class="st">'tool animal'</span><span class="op">)</span>,
    <span class="fu">lte</span><span class="op">(</span>patent_date <span class="op">=</span> <span class="st">"2010-01-01"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">query_1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_qfuns.html">with_qfuns</a></span><span class="op">(</span>
  <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">and</a></span><span class="op">(</span>
    <span class="fu">text_any</span><span class="op">(</span>patent_abstract <span class="op">=</span> <span class="st">'tool animal'</span><span class="op">)</span>,
    <span class="fu">gt</span><span class="op">(</span>patent_date <span class="op">=</span> <span class="st">"2010-01-01"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>That was fine when the overall size limit was 100,000 rows but how
about now?</p>
<p>Well, it turns out, we can use the API itself to help us figure out
what date ranges we could use! How cool is that? (here’s the function
that should probably become part of the R package)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns a list of start and end dates that won't exceed the new overall result</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set size limit.  </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The patentsview database starts with 1976 though we'll allow a start date and end date to be passed in.  </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The caller might want to pick up where they left off last time etc.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (Should they be R dates instead? Though we are returning string dates)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Enforce that patent_date isn't in the query?</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># They'll also need to have patent_date as the primary sort</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>safe_date_ranges <span class="ot">&lt;-</span> <span class="cf">function</span>(query, <span class="at">start_date =</span> <span class="st">'1976-01-01'</span>, end_date <span class="ot">&lt;-</span> <span class="fu">toString</span>(<span class="fu">Sys.Date</span>())  <span class="co"># today ) {</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>   fields <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"patent_date"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>   sort <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"patent_date"</span> <span class="ot">=</span> <span class="st">"asc"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>   per_page <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>   page <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>   <span class="at">date_ranges =</span> <span class="fu">list</span>()</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>   pos <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>   count <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>   <span class="cf">repeat</span>{</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      date_range <span class="ot">&lt;-</span> qry_funs<span class="sc">$</span><span class="fu">in_range</span>(<span class="at">patent_date=</span><span class="fu">c</span>(start_date, end_date))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      combined_query <span class="ot">&lt;-</span> qry_funs<span class="sc">$</span><span class="fu">and</span>(date_range, query)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">search_pv</span>(<span class="at">query =</span> combined_query, <span class="at">fields =</span> fields, <span class="at">sort =</span> sort,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                           <span class="at">per_page =</span> per_page, <span class="at">page =</span> <span class="dv">1</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      count <span class="ot">&lt;-</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ok, now we look at the total size of this query</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      total_hits <span class="ot">=</span> results<span class="sc">$</span>query_results<span class="sc">$</span>total_hits</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      rows <span class="ot">&lt;-</span> <span class="fu">length</span>(results<span class="sc">$</span>data<span class="sc">$</span>patents<span class="sc">$</span>patent_date)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="co"># we're done if the total_hits is 0, if the previous query got the last of the results</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># probably not even possible?  the previous query would have unknowingly grabbed the</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># last of the overall data set and we would have backed up one day, assuming there</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      <span class="co"># was more data, beyond the last patent_date we found</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(total_hits <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>         <span class="cf">break</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># we're done if the total_hit is less than 10,000</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the full query using the current start and end date will retrieve the last of</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the overall data set</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(total_hits <span class="sc">&lt;</span> <span class="dv">10000</span>) {</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>         date_ranges[[pos]] <span class="ot">=</span> <span class="fu">c</span>(start_date, end_date)  <span class="co"># add final pair needed</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>         <span class="cf">break</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>      <span class="co"># is this even possible?  we already know that total_hits &gt; 0</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(rows <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>         <span class="cf">break</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># so we have a full data set still, total_hits = 10000</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>      <span class="co"># we need to request the 10th page to get the last patent_date</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">search_pv</span>(<span class="at">query =</span> combined_query, <span class="at">fields =</span> fields, <span class="at">sort =</span> sort,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>                           <span class="at">per_page =</span> per_page, <span class="at">page =</span> <span class="dv">10</span>)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      count <span class="ot">&lt;-</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># probably has to be 1000 since total_hits = 10000</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      rows <span class="ot">&lt;-</span> <span class="fu">length</span>(results<span class="sc">$</span>data<span class="sc">$</span>patents<span class="sc">$</span>patent_date)  </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># grab the last patent date, this will become the new start date</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>      new_start_date <span class="ot">=</span> results<span class="sc">$</span>data<span class="sc">$</span>patents<span class="sc">$</span>patent_date[rows]</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># back up one day to get a safe end date with the current start date</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>      <span class="co"># (so the total result size will be less than 10,000)</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      safe_end_date <span class="ot">=</span> <span class="fu">toString</span>(<span class="fu">as.Date</span>(new_start_date) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>      date_ranges[[pos]]  <span class="ot">=</span> <span class="fu">c</span>(start_date, safe_end_date)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>      pos <span class="ot">=</span> pos <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      start_date <span class="ot">=</span> new_start_date</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"API calls made:"</span>, count))</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>   date_ranges</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Error: &lt;text&gt;:12:73: unexpected assignment</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11: </span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12: safe_date_ranges &lt;- function(query, start_date = '1976-01-01', end_date &lt;-</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                                                                             ^</span></span></code></pre></div>
<p>And here’s the same sample query as before to give it a go. Spoiler
alert, it takes 29 API calls just to determine the date ranges but then,
if we choose to, we could fire off the 15 pairs of date range restricted
calls (all but the last search_pv call would make 10 API calls when
all_pages = TRUE, guaranteeing we’d get throttled!).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_qfuns.html">with_qfuns</a></span><span class="op">(</span><span class="fu">text_any</span><span class="op">(</span>patent_abstract <span class="op">=</span> <span class="st">'tool animal'</span><span class="op">)</span><span class="op">)</span>

<span class="va">the_answer</span> <span class="op">&lt;-</span> <span class="fu">safe_date_ranges</span><span class="op">(</span><span class="va">query</span><span class="op">)</span>
<span class="co">#&gt; Error in safe_date_ranges(query): could not find function "safe_date_ranges"</span>

<span class="va">the_answer</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'the_answer' not found</span></code></pre></div>
<p>And now, since it’s fun, we’ll go through the motions of calling the
API for each date range. We won’t actually request all the data
(all_pages defaults to FALSE) but each call’s total_hit_count will be
displayed, showing the total row count of what would have been retrieved
if all_pages was TRUE. Note that none of date ranges would hit the new
limit of 10,000 rows.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"patent_date"</span> <span class="op">=</span> <span class="st">"asc"</span><span class="op">)</span>
<span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"patent_date"</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">pair</span> <span class="kw">in</span> <span class="va">the_answer</span><span class="op">)</span>
<span class="op">{</span>
   <span class="va">date_range</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">in_range</span><span class="op">(</span>patent_date<span class="op">=</span><span class="va">pair</span><span class="op">)</span>
   <span class="va">combined_query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">and</span><span class="op">(</span><span class="va">date_range</span>, <span class="va">query</span><span class="op">)</span>

   <span class="co"># just get one row! (per_page is 1, all_pages is FALSE)</span>
   <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">combined_query</span>, fields <span class="op">=</span> <span class="va">fields</span>, sort <span class="op">=</span> <span class="va">sort</span>,
                all_pages <span class="op">=</span> <span class="cn">FALSE</span>, per_page <span class="op">=</span> <span class="fl">1</span>, page <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

   <span class="va">total_hits</span> <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">query_results</span><span class="op">$</span><span class="va">total_hits</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">total_hits</span>,<span class="fu"><a href="https://rdrr.io/r/base/toString.html">toString</a></span><span class="op">(</span><span class="va">pair</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'the_answer' not found</span></code></pre></div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>So there you have it, our attempt at listing what’s changed and what
to do about it. <a href="https://patentsview.org/apis/keyrequest">Request</a> an API key
and get going with the new R package for the new version of the API!
(The two API versions will coexist for a while but eventually the
original version of the API will be retired.)</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Christopher Baker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
