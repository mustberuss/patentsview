<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="patentsview">
<title>Result Set Paging • patentsview</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Result Set Paging">
<meta property="og:description" content="patentsview">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">patentsview</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--api-changes">
    <span class="fa fa-flag"></span>
     
    API Changes
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--api-changes">
    <a class="dropdown-item" href="../articles/api-changes.html">
      <span class="fa fa-exclamation"></span>
       
      2025 API Changes
    </a>
    <a class="dropdown-item" href="../articles/converting-an-existing-script.html">
      <span class="fa fa-sync"></span>
       
      Converting an Existing Script
    </a>
    <a class="dropdown-item" href="../articles/result-set-paging.html">
      <span class="fa fa-book"></span>
       
      Result Set Paging
    </a>
    <a class="dropdown-item" href="../articles/understanding-the-api.html">
      <span class="fa fa-school"></span>
       
      Understanding the API
    </a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/getting-started.html">
    <span class="fa fa-play"></span>
     
    Getting started
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/writing-queries.html">
    <span class="fa fa-pencil"></span>
     
    Writing queries
  </a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--applications">
    <span class="fa fa-bar-chart"></span>
     
    Applications
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--applications">
    <a class="dropdown-item" href="../articles/examples.html">
      <span class="fa fa-code"></span>
       
      Examples
    </a>
    <a class="dropdown-item" href="../articles/top-assignees.html">
      <span class="fa fa-university"></span>
       
      Top assignees
    </a>
    <a class="dropdown-item" href="../articles/citation-networks.html">
      <span class="fa fa-long-arrow-left"></span>
       
      Citation networks
    </a>
    <a class="dropdown-item" href="../articles/ropensci-blog-post.html">
      <span class="fa fa-bullhorn"></span>
       
      ropensci announcement
    </a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/patentsview/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Result Set Paging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/patentsview/blob/HEAD/vignettes/articles/result-set-paging.Rmd" class="external-link"><code>vignettes/articles/result-set-paging.Rmd</code></a></small>
      <div class="d-none name"><code>result-set-paging.Rmd</code></div>
    </div>

    
    
<p>Paging changed in the new version of the Patentsview API and R
package. This vignette tries to explain the subtleties that the R
package handles for you and to show how to do custom paging.</p>
<p>The R package lets you make a single request of up to 1000 rows or to
retrieve all rows, with nothing in between, unless you do your own
paging. This might be important if you want to retrieve a few thousand
utility patents without retrieving all 8 million of them. Or maybe you
want to iterate through search results page by page rather than
retrieving the entire result set and then iterating. If you do your own
paging, you’ll need to be careful when choosing your sort parameter(s),
as shown in Example 2 and Example 3.</p>
<div class="section level2">
<h2 id="example-1">Example 1<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h2>
<p>Here we’ll retrieve 5000 utility patents using custom paging.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/patentsview/index.html">patentsview</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lets get 5000 of the most recent utility patents (when this was written),</span></span>
<span><span class="co"># 1000 at a time (the API's maximum rows per request)</span></span>
<span><span class="va">requested_rows</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span> <span class="op">=</span> <span class="st">"desc"</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"patent_type"</span> <span class="op">=</span> <span class="st">"utility"</span><span class="op">)</span></span>
<span><span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span>, <span class="st">"patent_date"</span>, <span class="st">"patent_title"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The "after" parameter is explained a bit lower.  It's an Elasticsearch thing,</span></span>
<span><span class="co"># and is the attrbute the new version of the API uses to page.  For now, just be </span></span>
<span><span class="co"># thankful that the R package handles this for you when you set all_pages = TRUE</span></span>
<span><span class="va">after</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"page"</span>, <span class="va">n</span>, <span class="st">"after is"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">after</span><span class="op">)</span>,<span class="st">"NULL"</span>,<span class="va">after</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">page_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">query</span>, fields <span class="op">=</span> <span class="va">fields</span>, sort <span class="op">=</span> <span class="va">sort</span>, </span>
<span>    all_pages <span class="op">=</span> <span class="cn">FALSE</span>, size <span class="op">=</span> <span class="va">requested_rows</span>, after <span class="op">=</span> <span class="va">after</span><span class="op">)</span></span>
<span>   <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sort</span><span class="op">)</span></span>
<span>   <span class="va">last_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">page_n</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>   <span class="va">after</span> <span class="op">&lt;-</span> <span class="va">page_n</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">last_index</span><span class="op">]</span><span class="op">]</span> <span class="co"># the last value of the sort field</span></span>
<span>   <span class="va">results</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">page_n</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "page 1 after is NULL"</span></span>
<span><span class="co">#&gt; [1] "page 2 after is 9999018"</span></span>
<span><span class="co">#&gt; [1] "page 3 after is 9998008"</span></span>
<span><span class="co">#&gt; [1] "page 4 after is 9996992"</span></span>
<span><span class="co">#&gt; [1] "page 5 after is 9995985"</span></span>
<span></span>
<span><span class="va">utility_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="va">as.data.frame</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">utility_sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    5000 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ patents.patent_id   : chr  "RE34947" "RE34357" "RE31704" "RE31701" ...</span></span>
<span><span class="co">#&gt;  $ patents.patent_title: chr  "Light-to-light conversion element provided with wavelength selecting reflection layer and imaging device provid"| __truncated__ "Loose-lay and adhered surface coverings" "Transformer having novel multiple winding and support structure and method of making same" "Portable label printing and applying machine" ...</span></span>
<span><span class="co">#&gt;  $ patents.patent_date : chr  "1995-05-23" "1993-08-24" "1984-10-09" "1984-10-09" ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-2">Example 2<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h2>
<p>Here we will execute a query two different ways, first having the R
package do the paging, the second will be our misguided attempt to do
the paging ourselves.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span>, <span class="st">"patent_date"</span>, <span class="st">"patent_title"</span><span class="op">)</span></span>
<span><span class="va">sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_date"</span> <span class="op">=</span> <span class="st">"asc"</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="st">'{"_and":[{"_gte":{"patent_date":"1976-01-01"}},{"_lte":{"patent_date":"1976-01-31"}}]}'</span></span>
<span><span class="va">r_pkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">query</span>, sort <span class="op">=</span> <span class="va">sort</span>, fields <span class="op">=</span> <span class="va">fields</span>, all_pages <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># note the number of rows returned</span></span>
<span><span class="va">r_pkg</span><span class="op">$</span><span class="va">query_results</span><span class="op">$</span><span class="va">total_hits</span></span>
<span><span class="co">#&gt; [1] 5352</span></span></code></pre></div>
<p>Quick piece of trivia: with a handful of exceptions, most US patents
were issued on a Tuesday. Here are the counts by issue date for January
1976 to help illustrate why what we’re about to do will lead to trouble.
(Note that the single patent issued on 1976-01-25 is a mistake in the
patentsview database but we need it here so the sum will match
r_pkg$query_results$total_hits just displayed)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>   <span class="va">issue_dates</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">r_pkg</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">patents</span><span class="op">$</span><span class="va">patent_date</span><span class="op">)</span></span>
<span>   <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">issue_dates</span>, <span class="kw">function</span><span class="op">(</span><span class="va">issue_date</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span>patent_date <span class="op">=</span> <span class="va">issue_date</span><span class="op">)</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span></span>
<span>      <span class="va">weekday</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">weekdays</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">issue_date</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">query_results</span><span class="op">$</span><span class="va">total_hits</span>, <span class="va">issue_date</span>, <span class="va">weekday</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">res</span><span class="op">$</span><span class="va">query_results</span><span class="op">$</span><span class="va">total_hits</span></span>
<span>   <span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1379 1976-01-06 Tuesday"</span></span>
<span><span class="co">#&gt; [1] "1257 1976-01-13 Tuesday"</span></span>
<span><span class="co">#&gt; [1] "1383 1976-01-20 Tuesday"</span></span>
<span><span class="co">#&gt; [1] "1 1976-01-25 Sunday"</span></span>
<span><span class="co">#&gt; [1] "1332 1976-01-27 Tuesday"</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5352</span></span></code></pre></div>
<p>Now we’ll try to do our own paging but, as you might notice, we’ll
run into trouble using patent_date as the sort field ( and thus the
‘after’ parameter we’ll send to the API).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">after</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">count</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">requested_rows</span> <span class="op">&lt;-</span> <span class="fl">1000</span>  <span class="co"># API's maximum rows per request</span></span>
<span></span>
<span><span class="co"># these variables remain the same</span></span>
<span><span class="va">sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_date"</span> <span class="op">=</span> <span class="st">"asc"</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="st">'{"_and":[{"_gte":{"patent_date":"1976-01-01"}},{"_lte":{"patent_date":"1976-01-31"}}]}'</span></span>
<span><span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span>, <span class="st">"patent_date"</span>, <span class="st">"patent_title"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We'll continue to make requests until we get back an empty or partial</span></span>
<span><span class="co"># response from the API</span></span>
<span><span class="va">page</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="kw">repeat</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"page"</span>, <span class="va">page</span>, <span class="st">"after is"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">after</span><span class="op">)</span>, <span class="st">"NULL"</span>, <span class="va">after</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">subsequent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">query</span>, sort <span class="op">=</span> <span class="va">sort</span>, all_pages <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    fields <span class="op">=</span> <span class="va">fields</span>, size <span class="op">=</span> <span class="va">requested_rows</span>, after <span class="op">=</span> <span class="va">after</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># subsequent$data$patents is an empty list if we page too far</span></span>
<span>  <span class="va">returned_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subsequent</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">patents</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subsequent</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">patents</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">returned_rows</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">combined_data</span>, <span class="va">subsequent</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">patents</span><span class="op">)</span></span>
<span>     <span class="va">count</span> <span class="op">&lt;-</span> <span class="va">count</span> <span class="op">+</span> <span class="va">returned_rows</span> </span>
<span>     <span class="va">page</span> <span class="op">&lt;-</span> <span class="va">page</span>  <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># We're done if we got an empty or partial reply from the API</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">returned_rows</span> <span class="op">&lt;</span> <span class="va">requested_rows</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="kw">break</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Now to page we need to set the "after" attribute to where the</span></span>
<span>  <span class="co"># current results ended.  Its value is the last row's [[sort field]]. </span></span>
<span>  <span class="co"># It would need to be an array of values if there are multiple sort fields</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sort</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">after</span> <span class="op">&lt;-</span> <span class="va">subsequent</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">returned_rows</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "page 1 after is NULL"</span></span>
<span><span class="co">#&gt; [1] "page 2 after is 1976-01-06"</span></span>
<span><span class="co">#&gt; [1] "page 3 after is 1976-01-13"</span></span>
<span><span class="co">#&gt; [1] "page 4 after is 1976-01-20"</span></span>
<span><span class="co">#&gt; [1] "page 5 after is 1976-01-27"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"count is"</span>, <span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "count is 4000"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4000</span></span></code></pre></div>
<p>We ran into trouble since we chose patent_date as the sort field
which isn’t unique row-wise in our result set as patent_id was in
Example 1. In most cases when we set ‘after’ to the last patent_date of
a page of results, we weren’t done retrieving all of that date’s
patents. (The page breaks aren’t guaranteed to align with the
patent_date changes in the result set. See the page boundary shown in
next example if this isn’t clear yet.)</p>
<p>The R package uses appropriate key(s) when
<code>all_pages = TRUE</code>. <code>get_ok_pk(endpoint)</code> has been
changed to also return a secondary sort key when needed. The next
example shows that sometimes a secondary sort is required to guarantee
row uniqueness (vital for paging via the ‘after’ parameter, so the API
properly picks up exactly where the previous page of data left off).</p>
</div>
<div class="section level2">
<h2 id="example-3">Example 3<a class="anchor" aria-label="anchor" href="#example-3"></a>
</h2>
<p>Here we’ll demonstrate that sometimes, in order to do custom paging,
a secondary sort is required. Normally the R package handles this for
its users when all_pages = TRUE. It all has to do with the way the API
now handles paging, where the sort key(s) is(are) used to determine the
‘after’ parameter’s value(s), instructing the API where the next page of
results begins.</p>
<p>Some of the new endpoints can return more than one row of data for
their primary key. They are the endpoints that have a sequence
parameter. Sorting and thus paging by only the primary key at these
endpoints can lead to trouble, like sorting by patent_date did in the
second half of Example 2.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sequence_eps</span> <span class="op">&lt;-</span> <span class="va">fieldsdf</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^[^.]*sequence"</span>,<span class="va">fieldsdf</span><span class="op">$</span><span class="va">field</span><span class="op">)</span>, <span class="st">"endpoint"</span><span class="op">]</span></span>
<span>  <span class="va">seq_pks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sequence_eps</span>, <span class="kw">function</span><span class="op">(</span><span class="va">endpoint</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">endpoint</span>, <span class="fu"><a href="../reference/get_ok_pk.html">get_ok_pk</a></span><span class="op">(</span><span class="va">endpoint</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sequences_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">seq_pks</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sequences_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"endpoint"</span>, <span class="st">"primary"</span>, <span class="st">"secondary"</span><span class="op">)</span></span>
<span>  <span class="va">sequences_df</span></span>
<span><span class="co">#&gt;                         endpoint         primary          secondary</span></span>
<span><span class="co">#&gt; 1                        g_claim       patent_id     claim_sequence</span></span>
<span><span class="co">#&gt; 2               g_draw_desc_text       patent_id draw_desc_sequence</span></span>
<span><span class="co">#&gt; 3        patent/foreign_citation       patent_id  citation_sequence</span></span>
<span><span class="co">#&gt; 4         patent/other_reference       patent_id reference_sequence</span></span>
<span><span class="co">#&gt; 5 patent/us_application_citation       patent_id  citation_sequence</span></span>
<span><span class="co">#&gt; 6      patent/us_patent_citation       patent_id  citation_sequence</span></span>
<span><span class="co">#&gt; 7                       pg_claim document_number     claim_sequence</span></span>
<span><span class="co">#&gt; 8              pg_draw_desc_text document_number draw_desc_sequence</span></span></code></pre></div>
<p>Ok, so here we’ll do a minimalist custom paging with a secondary sort
using the patent/us_patent_citation endpoint. The code is similar to
what’s in the <a href="citation-networks.html">citation network
vignette</a>, where we first learned that a primary sort is not always
sufficient (requiring changes to the R package).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Write a query to pull patents assigned to the CPC code of "Y10S707/933"</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">contains</span><span class="op">(</span>cpc_current.cpc_group_id <span class="op">=</span> <span class="st">"Y10S707/933"</span><span class="op">)</span></span>
<span><span class="va">pv_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">query</span>, fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">patent_ids</span> <span class="op">&lt;-</span> <span class="va">pv_out</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">patents</span><span class="op">$</span><span class="va">patent_id</span></span>
<span></span>
<span><span class="co"># We have to go against the patent citiation endpoint now, these fields</span></span>
<span><span class="co"># are no longer available from the patent endpoint</span></span>
<span></span>
<span><span class="va">citing_query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span>patent_id <span class="op">=</span> <span class="va">patent_ids</span><span class="op">)</span></span>
<span><span class="va">cited_query</span> <span class="op">&lt;-</span> <span class="va">qry_funs</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span>citation_patent_id <span class="op">=</span> <span class="va">patent_ids</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list of fields to pull from the API</span></span>
<span><span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"patent_id"</span>,</span>
<span>  <span class="st">"citation_patent_id"</span>,</span>
<span>  <span class="st">"citation_sequence"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patent_id"</span> <span class="op">=</span> <span class="st">"asc"</span>, <span class="st">"citation_sequence"</span> <span class="op">=</span> <span class="st">"asc"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Request the first page of results</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">citing_query</span>,</span>
<span>  fields <span class="op">=</span> <span class="va">fields</span>, all_pages <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  sort <span class="op">=</span>  <span class="va">sort</span>,</span>
<span>  endpoint <span class="op">=</span> <span class="st">"patent/us_patent_citation"</span>, method <span class="op">=</span> <span class="st">"POST"</span>, size <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">last_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span><span class="op">)</span></span>
<span><span class="va">last_patent_id</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span><span class="op">$</span><span class="va">patent_id</span><span class="op">[[</span><span class="va">last_row</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">last_citation_sequence</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span><span class="op">$</span><span class="va">citation_sequence</span><span class="op">[[</span><span class="va">last_row</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">after</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">last_patent_id</span>, <span class="va">last_citation_sequence</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">after</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "8818996" "6"</span></span>
<span></span>
<span><span class="co"># make our own request to get the second page of results, knowing that's it (1066 total rows)</span></span>
<span><span class="va">remaining</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_pv.html">search_pv</a></span><span class="op">(</span><span class="va">citing_query</span>,</span>
<span>  fields <span class="op">=</span> <span class="va">fields</span>, all_pages <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  sort <span class="op">=</span>  <span class="va">sort</span>,</span>
<span>  after <span class="op">=</span> <span class="va">after</span>,</span>
<span>  endpoint <span class="op">=</span> <span class="st">"patent/us_patent_citation"</span>, method <span class="op">=</span> <span class="st">"POST"</span>, size <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">blend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">remaining</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">blended</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">blend</span>, make.row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">blended</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">blended</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ us_patent_citations:'data.frame': 1066 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ patent_id         : chr [1:1066] "10095778" "10095778" "10095778" "10095778" ...</span></span>
<span><span class="co">#&gt;   ..$ citation_sequence : int [1:1066] 0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">#&gt;   ..$ citation_patent_id: chr [1:1066] "4991087" "5175681" "5392390" "5461699" ...</span></span></code></pre></div>
<p>Here’s a quick look at the data around the page boundary to try to
show why we needed a secondary sort. It’s not that we necessarily wanted
a secondary sort, but it gives us the ability to use a second column’s
value in the ‘after’ parameter.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ending of the first page of results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span>, n<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;      patent_id citation_sequence citation_patent_id</span></span>
<span><span class="co">#&gt; 998    8818996                 4            5680305</span></span>
<span><span class="co">#&gt; 999    8818996                 5            5694592</span></span>
<span><span class="co">#&gt; 1000   8818996                 6            5721910</span></span>
<span></span>
<span><span class="co">#  ***********  data page boundary ***********  </span></span>
<span></span>
<span><span class="co"># start of the second page of results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">remaining</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span>, n<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   patent_id citation_sequence citation_patent_id</span></span>
<span><span class="co">#&gt; 1   8818996                 7            5754840</span></span>
<span><span class="co">#&gt; 2   8818996                 8            5774833</span></span>
<span><span class="co">#&gt; 3   8818996                 9            5799325</span></span>
<span></span>
<span><span class="co"># end of the second page of results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">remaining</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">us_patent_citations</span>, n<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;    patent_id citation_sequence citation_patent_id</span></span>
<span><span class="co">#&gt; 64   9075849                34            7451388</span></span>
<span><span class="co">#&gt; 65   9075849                35            7912842</span></span>
<span><span class="co">#&gt; 66   9075849                36            7962511</span></span>
<span></span>
<span><span class="co"># If the sort was only by patent_id, the second request would return</span></span>
<span><span class="co"># zero rows since there aren't patent_ids 'after' 10095778</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="takeaways">Takeaways<a class="anchor" aria-label="anchor" href="#takeaways"></a>
</h2>
<p>Again, when <code>all_pages = TRUE</code> the R package handles all
of this for you! You’d only need code like this if your use case
requires custom paging. The custom paging takeaways are:</p>
<ol style="list-style-type: decimal">
<li>The original version of the API and R package used
<code>per_page</code> and <code>page</code> to allow users to page
through result sets. Those attributes are replaced by <code>size</code>
and <code>after</code> in the new version of the API and R package.</li>
<li>Your sort field(s) need to create row-wise uniqueness. At a minimum
the <code>get_ok_pk(endpoint)</code> fields need to be included as sort
fields though others can be added.</li>
<li>If there is a single sort field, the after parameter’s value is the
sort field’s last value in the most recently retrieved page of data (as
in Example 1). If there are multiple sort fields, the after parameter’s
value is a vector of the sort fields’ last values (as in Example
3).</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Baker, Russ Allen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
