---
title: "API Changes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{API Changes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  comment = "#>", 
  warning = FALSE,
  message = FALSE
)
```

## Summary of the API changes announced in 2021
 
In July of 2021 the Patentview API team announced upcoming API changes here https://patentsview.org/data-in-action/whats-new-patentsview-july-2021.  This page will explain the impact to the r package and any existing code.
 
The Patentsview API team has provided a Swagger UI page for the new version of the API at https://search.patentsview.org/swagger-ui/. It shows all the available endpoints and their responses.  Each field in the 200 response sections could be requested in the f: parameter and each field is supposed to be queryable.  The Swagger UI page can be used to make requests, if you have an API key to enter in the authorization screen, more about the new API key below.  The Swagger UI definition at https://patentsview.historicip.com/swagger/openapi_v2.yml can be imported into Postman to give you a nicely loaded collection for the changed API. You'll just need to set a global variable PVIEW_KEY and set the authorization's value to {{PVIEW_KEY}} to your API key. (The patentsview's Swagger UI definition https://search.patentsview.org/static/openapi_v2.yml could be imported into Postman but it currently contains errors and does not contain a servers entry.  This was reported to the API team.)

## An API Key is required
Perhaps the most important change, without an API key your queries will be rejected.  Request an API key using this link: https://patentsview.org/apis/keyrequest  Once you have one, you'll need to set an environmental variable PATENTSVIEW_API_KEY to the value of your API key for the R package to use.

## Philosophical Changes
These changes are likely to break existing code.  Now there are more endpoints and each returns a smaller, more specific data structure pertinent to that endpoint. As an example, previously the inventor endpoint could return assignee information, it no longer does that.  The exception is the patent endpoint.  It now can return assignees_at_grant, inventors_at_grant, cpc_current along with patent specific fields. Note that now subsequent queries would have to be made to the USPC specific endpoints if you are looking for these fields.

Now there are 13 endpoints, up from the original 7.  The urls changed slightly but the R package takes care of that for you. 
1. There are 2 totally new endpoints
    *  /api/v1/patent_citation/
    *  /api/v1/application_citation/
2. 7 of the original api's endpoints have singular names but lighter responses and fewer queryable fields as mentioned above. 
   *  /api/v1/assignee/
   *  /api/v1/inventor/
   *  /api/v1/location/  (not currently on the test server)
   *  /api/v1/patent/
   *  /api/v1/cpc_subsection/
   *  /api/v1/nber_subcategory/
   *  /api/v1/uspc_subclass/
3. There are an additional 4 new endpoints which are subdivisions of the original classification endpoints
   * /api/v1/cpc_group/
   * /api/v1/cpc_subgroup/
   * /api/v1/nber_category/
   * /api/v1/uspc_mainclass/

## Data Reduction

Quite a few fields seem to have gone away, including government interest fields, ipc fields, wipo fields, lawyer fields, foreign_priority fields, examiner fields, pct fields, raw inventor fields, coinventor fields, patent_firstnamed fields or patent_num_claims.  There's a link to a spreadsheet of the fields returned by endpoint at the bottom of https://patentsview.org/apis/purpose


## HATEOAS
Some of the returned fields are links to retrieve more information about that field. Slight funky is the cpc_current's cpc_subgroup, returned by the patent endpoint.  Here the slash in the cpc is turned into a colon.  This is a picularity of two of the new convience urls that shouldn't be noticable in the r package, unless you are trying to infer the uspc and cpc values from the returned urls.

 "cpc_current": {
     "cpc_subgroup": "https://search.patentsview.org/api/v1/cpc_subgroup/G01S7:4865/" 
  }

Note that you'll get an error if you click on that link as an API key is not sent with as the  
X-Api-Key header.  The response will be an http 403 Forbidden, instead of a 200.


## Query size changes
1. The default result set size is now 100, originally it was 25. 
2. The maximum rows that can be requested at one time is now 1,000, down from 10,000
3. The overall paged result set size limit is now 10,000 rows, down from the original 100,000 

The R package should take care of these changes, though you may have to make additional
queries to get around the new overall paged result set size of 10,000 rows.

## Throttling
The API will now allow 45 requests per minute, making more requests will anger the API.  It will send back an error code with a header indicating how many seconds to wait before repeating the query.  The R package should take care of this for you.

## Miscellaneous Changes

* Some of the fields names changed.  assignee_last_name is now name_last in the assignees data structure.

* Some string fields are now full text fields, meaning you need to use different methods
when including them in your query.  Example:  assignee organization is renamed organization and is now a full text field, formerly it had been a string. 

* There are some new convience methods, which take url parameters.  The API will still respond to GETs and POSTs, so the R package won't need to use these new urls.

* The API's endpoints are now singular, instead of being plural.  Ex /patents is now /patent  The returned data structures are still plural, ex. patents.  The R package will keep using the plural endpoints to match the returned data structures.  There would be a small chance that an existing script would work, once the now-required API key is set up.

* All fields are supposed to be queryable with the new version of the API.

* The subdomain of the API changed from https://api.patentsview.org/ to https://search.patentsview.org.  The patentsview package takes care of this for you.

* Nested fields seem to need to be fully qualified in the f:parameter. Here are all the patent endpoint's fields:
```{r}
library(patentsview)
get_fields("patents")
```
