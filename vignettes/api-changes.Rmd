---
title: "API Changes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{API Changes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



## Summary of the API changes announced in 2021
 
In July of 2021 the Patentview API team announced upcoming API changes here https://patentsview.org/data-in-action/whats-new-patentsview-july-2021.  This page will explain the impact to the r package and any existing code.
 
The Patentsview API team has provided a Swagger UI page for the new version of the API at https://search.patentsview.org/swagger-ui/. It shows all the available endpoints and their responses.  Each field in the 200 response sections could be requested in the fields/f: parameter and each field is supposed to be queryable (usable in the query/q: parameter).  The Swagger UI page can be used to make requests, if you have an API key to enter in the authorization screen, more about the new API key below.  The Swagger UI definition at https://patentsview.historicip.com/swagger/openapi_v2.yml can be imported into Postman to give you a nicely loaded collection for the changed API. You'll just need to set a global variable PVIEW_KEY and set the authorization's value to {{PVIEW_KEY}} to your API key. (The patentsview's Swagger UI definition https://search.patentsview.org/static/openapi_v2.yml could be imported into Postman but it currently contains errors and does not contain a servers entry.  This was reported to the API team.)

## An API Key is required
Perhaps the most important change, without an API key your queries will be rejected.  Request an API key using this link: https://patentsview.org/apis/keyrequest  Once you have one, you'll need to set an environmental variable PATENTSVIEW_API_KEY to the value of your API key for the R package to use.

## Philosophical Changes
These changes are likely to break existing code.  Now there are more endpoints and each returns a smaller, more specific data structure pertinent to that endpoint. As an example, previously the inventor endpoint could return assignee information, it no longer does that.  The exception is the patents endpoint.  It now can return assignees_at_grant, inventors_at_grant, cpc_current along with patent specific fields. Note that now subsequent queries would have to be made to the USPC specific endpoints if you are looking for these fields.

Currently there are 13 endpoints, up from the original 7.  The urls changed slightly but the R package takes care of that for you.  

1. There are 2 totally new endpoints  
   -  /api/v1/patent_citation/  
   -  /api/v1/application_citation/  
2. 7 of the original api's endpoints have singular names but lighter responses and fewer queryable fields as mentioned above.  
   -  /api/v1/assignee/  
   -  /api/v1/inventor/  
   -  /api/v1/location/  (not currently on the test server)  
   -  /api/v1/patent/  
   -  /api/v1/cpc_subsection/  
   -  /api/v1/nber_subcategory/  
   -  /api/v1/uspc_subclass/  
3. There are an additional 4 new endpoints which are subdivisions of the original classification endpoints.  
   - /api/v1/cpc_group/  
   - /api/v1/cpc_subgroup/  
   - /api/v1/nber_category/  
   - /api/v1/uspc_mainclass/  

## Data Reduction

Quite a few fields seem to have gone away, including government interest fields, ipc fields, wipo fields, lawyer fields, foreign_priority fields, examiner fields, pct fields, raw inventor fields, coinventor fields, patent_firstnamed fields or patent_num_claims.  There's a link to a spreadsheet of the fields returned by endpoint at the bottom of https://patentsview.org/apis/purpose though the Swagger UI page should be more current.


## HATEOAS
Some of the returned fields are HATEOAS (Hypermedia as the Engine of Application State) links to retrieve more information about that field. Slight funky is the cpc_current's cpc_subgroup, returned by the patents endpoint.  Here the slash in the cpc is turned into a colon.  This is a peculiarity of two of the new convience urls that shouldn't be noticable in the r package, unless you are trying to infer the uspc and cpc values from the returned urls, without actually calling back for this data.
There is something slightly funky with these fields.  They have an _id when in the q:/query and f:/fields parameters but they are returned without the _id.  Example: cpc_subgroup_id is returned as the HATEOAS link cpc_subgroup. 

Example link returned by the patents endpoint
```
 "cpc_current": {
     "cpc_subgroup": "https://search.patentsview.org/api/v1/cpc_subgroup/G01S7:4865/"  
  }
```
Note that going to that link in a browser will result in a 403 Unauthorized, as no API key is sent.

There is a new method in the R package to retrive data from the HATEOAS links, just pass the returned
link and the R package will retrieve the data for you.  

```r
library(patentsview)

retrieve_linked_data("https://search.patentsview.org/api/v1/cpc_subgroup/G01S7:4865/")
#> $data
#> [1] "cpc_subgroups"
#> #### A list with a single data frame on a CPC sub group level:
#> 
#> List of 1
#>  $ cpc_subgroups:'data.frame':	1 obs. of  2 variables:
#>   ..$ cpc_subgroup_id   : chr "G01S7/4865"
#>   ..$ cpc_subgroup_title: chr "Details of systems according to groups G01S13/"..
#> 
#> $query_results
#> #### Distinct entity counts across all downloadable pages of output:
#> 
#> total_hits = 1
```

## Query size changes
1. The maximum rows that can be requested at one time is now 1,000, down from 10,000
2. The overall paged result set size limit is now 10,000 rows, down from the original 100,000 

The R package should take care of these changes, though you may have to make additional
queries to get around the new overall paged result set size of 10,000 rows.  See the [Converting an Existing Script](converting-an-existing-script.html#reduced-query-size-1) vignette for more on this.

## Throttling
The API will now allow 45 requests per minute, making more requests will anger the API.  It will send back an error code with a header indicating how many seconds to wait before sending more queries.  The R package will take care of this for you.  It will sleep for the required number of seconds before resubmitting your query, seemlessly to your script.

## Alpha Fields

fieldsdf will show you the field types, names and endpoints in the new version of the API.  There are different operators for string and full text fields.

```r
library(knitr)
library(dplyr)

string_fields <-
   fieldsdf %>%
      filter(data_type == "string")  %>%
      select(endpoint, field, data_type) %>%
      arrange(`endpoint`, `field`)  
 
kable(string_fields,  row.names = FALSE, caption = 'String Fields')
```



|endpoint              |field                    |data_type |
|:---------------------|:------------------------|:---------|
|patents               |patent_number            |string    |
|patents               |patent_title             |string    |
|patents               |patent_type              |string    |
|patents               |patent_kind              |string    |
|patent_citations      |patent_number            |string    |
|patent_citations      |cited_patent_number      |string    |
|patent_citations      |citation_category        |string    |
|application_citations |citation_category        |string    |
|application_citations |cited_application_number |string    |
|cpc_subsections       |cpc_section_id           |string    |
|cpc_subsections       |cpc_subsection_id        |string    |
|uspc_mainclasses      |uspc_mainclass_id        |string    |
|nber_categories       |nber_category_id         |string    |
|nber_subcategories    |nber_subcategory_id      |string    |

```r

fulltext_fields <-
   fieldsdf %>%
      filter(data_type == "full text")  %>%
      select(endpoint, field, data_type) %>%
      arrange(endpoint, field)  
 
kable(fulltext_fields ,  row.names = FALSE, caption = 'Full Text Fields')
```



|endpoint              |field                                                        |data_type |
|:---------------------|:------------------------------------------------------------|:---------|
|patents               |patent_country                                               |full text |
|patents               |patent_abstract                                              |full text |
|patents               |patent_uspc_current_mainclass_average_patent_processing_days |full text |
|patents               |assignees_at_grant.assignee_id                               |full text |
|patents               |assignees_at_grant.name_first                                |full text |
|patents               |assignees_at_grant.name_last                                 |full text |
|patents               |assignees_at_grant.organization                              |full text |
|patents               |assignees_at_grant.type                                      |full text |
|patents               |assignees_at_grant.city                                      |full text |
|patents               |assignees_at_grant.state                                     |full text |
|patents               |assignees_at_grant.country                                   |full text |
|patents               |inventors_at_grant.inventor_id                               |full text |
|patents               |inventors_at_grant.name_first                                |full text |
|patents               |inventors_at_grant.name_last                                 |full text |
|patents               |inventors_at_grant.city                                      |full text |
|patents               |inventors_at_grant.state                                     |full text |
|patents               |inventors_at_grant.country                                   |full text |
|patents               |cpc_current.cpc_section_id                                   |full text |
|patents               |cpc_current.cpc_subsection                                   |full text |
|patents               |cpc_current.cpc_group                                        |full text |
|patents               |cpc_current.cpc_subgroup_id                                  |full text |
|patents               |cpc_current.cpc_subgroup_title                               |full text |
|assignees             |lastknown_city                                               |full text |
|assignees             |lastknown_country                                            |full text |
|assignees             |lastknown_state                                              |full text |
|assignees             |name_first                                                   |full text |
|assignees             |name_last                                                    |full text |
|assignees             |num_inventors                                                |full text |
|assignees             |num_patents                                                  |full text |
|assignees             |organization                                                 |full text |
|inventors             |lastknown_city                                               |full text |
|inventors             |lastknown_country                                            |full text |
|inventors             |lastknown_state                                              |full text |
|inventors             |name_first                                                   |full text |
|inventors             |name_last                                                    |full text |
|inventors             |num_patents                                                  |full text |
|inventors             |inventor_id                                                  |full text |
|inventors             |num_assignees                                                |full text |
|application_citations |patent_number                                                |full text |
|cpc_subsections       |cpc_subsection_title                                         |full text |
|cpc_groups            |cpc_subsection_id                                            |full text |
|cpc_groups            |cpc_group_id                                                 |full text |
|cpc_groups            |cpc_group_title                                              |full text |
|cpc_subgroups         |cpc_subsection_id                                            |full text |
|cpc_subgroups         |cpc_group_id                                                 |full text |
|cpc_subgroups         |cpc_subgroup_id                                              |full text |
|cpc_subgroups         |cpc_subgroup_title                                           |full text |
|uspc_mainclasses      |uspc_mainclass_title                                         |full text |
|uspc_subclasses       |uspc_mainclass_id                                            |full text |
|uspc_subclasses       |uspc_subclass_id                                             |full text |
|uspc_subclasses       |uspc_subclass_title                                          |full text |
|nber_categories       |nber_category_title                                          |full text |
|nber_subcategories    |nber_subcategory_title                                       |full text |

## Other Changes

* Some of the fields names changed.  assignee_last_name is now name_last in the assignees data structure.

* Some fields' types have changed, some strings in the original version of the API have become a full text field and some full text fields have becomes strings.  This means you'll need to use different methods
when including them in your query.  Example: assignee organization is renamed organization and is now a full text field, formerly it had been a string.

* The API's endpoints are now singular, instead of being plural.  Ex /patents is now /patent  The returned data structures are still plural, ex. patents.  The R package will keep using the plural endpoint names to match the returned data structures. When calling the API, the R package will request the singular endpoints. There would be a small chance that an existing script would work, once the now-required API key is set up.

* All fields are supposed to be queryable with the new version of the API.

* The subdomain of the API changed from https://api.patentsview.org/ to https://search.patentsview.org.  The R package takes care of this for you.

* Nested fields seem to need to be fully qualified in the f:parameter. Here are all the patents endpoint's fields:

```r
get_fields("patents")
#>  [1] patent_number                                               
#>  [2] patent_title                                                
#>  [3] patent_date                                                 
#>  [4] patent_type                                                 
#>  [5] patent_country                                              
#>  [6] patent_year                                                 
#>  [7] patent_abstract                                             
#>  [8] patent_kind                                                 
#>  [9] patent_num_foreign_documents_cited                          
#> [10] patent_num_us_applications_cited                            
#> [11] patent_num_us_patents_cited                                 
#> [12] patent_num_total_documents_cited                            
#> [13] patent_num_times_cited_by_us_patents                        
#> [14] patent_earliest_application_date                            
#> [15] patent_patent_processing_days                               
#> [16] patent_uspc_current_mainclass_average_patent_processing_days
#> [17] patent_cpc_current_group_average_patent_processing_days     
#> [18] patent_term_extension                                       
#> [19] patent_detail_desc_length                                   
#> [20] assignees_at_grant.assignee_id                              
#> [21] assignees_at_grant.name_first                               
#> [22] assignees_at_grant.name_last                                
#> [23] assignees_at_grant.organization                             
#> [24] assignees_at_grant.type                                     
#> [25] assignees_at_grant.city                                     
#> [26] assignees_at_grant.state                                    
#> [27] assignees_at_grant.country                                  
#> [28] assignees_at_grant.latitude                                 
#> [29] assignees_at_grant.longitude                                
#> [30] inventors_at_grant.inventor_id                              
#> [31] inventors_at_grant.name_first                               
#> [32] inventors_at_grant.name_last                                
#> [33] inventors_at_grant.city                                     
#> [34] inventors_at_grant.state                                    
#> [35] inventors_at_grant.country                                  
#> [36] inventors_at_grant.latitude                                 
#> [37] inventors_at_grant.longitude                                
#> [38] cpc_current.sequence                                        
#> [39] cpc_current.cpc_section_id                                  
#> [40] cpc_current.cpc_subsection                                  
#> [41] cpc_current.cpc_group                                       
#> [42] cpc_current.cpc_subgroup_id                                 
#> [43] cpc_current.cpc_subgroup_title                              
#> 108 Levels: patent_number patent_title patent_date ... nber_subcategory_years_active
```
