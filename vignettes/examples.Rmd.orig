---
title: "Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Recent API Change

With the recent [API changes](api-changes.html), the patents endpoint is the main way to retrieve data. The other 
endpoints supply additional information.  Also note that an API key is required.

## Patents endpoint

Which patents have been cited by more than 500 US patents?

```{r}
library(patentsview)

search_pv(query = qry_funs$gt(patent_num_times_cited_by_us_patents = 500))
```

How many distinct inventors are represented by these highly-cited patents?

```{r}

search_pv(
  query = qry_funs$gt(patent_num_times_cited_by_us_patents = 500),
  fields = c("patent_id", "inventors.inventor_id")
)
```
What assignee's organizations start Microsoft?

```{r}
query <- qry_funs$begins(assignee_organization = "Microsoft")

pv_out <- search_pv(query, endpoint = "assignees")
pv_out$data$assignees$assignee_organization
```

Where geographically have Microsoft inventors been coming from over the past few years?

Note that the api currently returns no results for "Microsoft Corporation" but will return
"Microsoft Corporation", 
"Microsoft Corporationâ€”One Microsoft Way"

```{r}
# Write the query
query <- with_qfuns(
  and(
    gte(patent_date = "2022-07-26"), # Dates are in yyyy-mm-dd format
    begins(assignees.assignee_organization = "Microsoft")
  )
)

# Create a field list
inv_fields <- get_fields(endpoint = "patents", groups = "inventors")
fields <- c(inv_fields, "patent_id")

# Pull the data
pv_out <- search_pv(query, fields = fields, all_pages = TRUE, per_page = 1000)

# Unnest the inventor list column
unnest_pv_data(pv_out$data, "patent_id")
```

Which inventors have Chicago, IL listed as their location on at least one patent.[^1]

```{r}
pv_out <- search_pv(
  query = '{"_and":[{"_text_phrase": {"inventors.city":"Chicago"}},{"_text_phrase": {"inventors.state":"IL"}}]}',
  endpoint = "patents"
)

pv_out

if (pv_out$query_results$total_hits == 0) {
  print("something seems to be wrong with the API")
}
```

Which assignees have an interest in beer?

```{r}
search_pv(
  query = qry_funs$contains(patent_title = "beer"),
  endpoint = "patents"
)
```

[^1]: Example taken from https://patentsview.org/apis/api-endpoints/inventors.
